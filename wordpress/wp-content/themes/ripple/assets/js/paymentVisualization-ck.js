// pvm stands for paymentVisualizationModule
// note the last line: var paymentVisualizationModule = pvm;
var pvm={};$(document).ready(function(){pvm.WIDTH=$("#visualization").width();pvm.HEIGHT=$("#visualization").height();pvm.svg=d3.select("#visualization").append("svg:svg").attr("width",pvm.WIDTH).attr("height",pvm.HEIGHT).attr("pointer-events","all").call(d3.behavior.zoom({dblclick:!1,wheel:!1}));pvm.svg.on("mousewheel.zoom",null);$("#visualization").append('<span class="pull-right" id="explanation"><i class="icon-question-sign"></i></span>');$("#explanation").tooltip({title:"This is a visualization of transactions on the ripple network.\nCircles are actual wallets on the ripple network.  Lines represent payments moving between wallets.",placement:"left"});pvm.linkGroup=pvm.svg.append("g").attr("id","linkGroup");pvm.labelGroup=pvm.svg.append("g").attr("id","labelGroup");pvm.nodeGroup=pvm.svg.append("g").attr("id","nodeGroup");pvm.force=d3.layout.force().size([pvm.WIDTH,pvm.HEIGHT]).friction(.2).gravity(0).charge(-800).nodes([]).links([]).start();pvm.force.on("tick",function(e){var t=pvm.svg.selectAll("circle.node");t.attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y});var n=pvm.svg.selectAll("line");n.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){var t=e.target.x-e.source.x,n=0;t!=0&&(n=e.r2/Math.sqrt(1+Math.pow((e.target.y-e.source.y)/t,2)));t<0&&(n*=-1);return e.target.x-n}).attr("y2",function(e){var t=e.target.x-e.source.x,n=0;if(t!=0){var r=(e.target.y-e.source.y)/t;n=e.r2*r/Math.sqrt(1+Math.pow(r,2))}else n=e.r2*(r?r<0?r-1:1:0);t<0&&(n*=-1);return e.target.y-n});var r=pvm.svg.selectAll("foreignObject");r.attr("x",function(e){return(e.source.x+e.target.x)/2-82}).attr("y",function(e){return(e.source.y+e.target.y)/2-26})})});pvm.tx_stack=[];pvm.tx_counter=0;pvm.loadHistoricalData=function(e){pvm.tx_stack=e.recent_payments.concat(pvm.tx_stack);pvm.startInterval()};pvm.handleNewEvent=function(e){if(e.type==="transaction"){var t=e.transaction;t.TransactionType==="Payment"&&pvm.tx_stack.push(t)}};pvm.startInterval=function(){pvm.intervalFunction();setInterval(pvm.intervalFunction,3e3)};pvm.intervalFunction=function(){if(pvm.tx_stack.length>0){var e=pvm.tx_stack.pop();pvm.renderTransaction(e)}};pvm.renderTransaction=function(e){var t=pvm.generateNodeCoordinates(e);pvm.addNodesToD3(t);setTimeout(function(){var e=$("#link"+t.id);pvm.animateLine(e,!0,.1,function(e){setTimeout(function(){pvm.animateLine(e,!1,.1)},3e3)})},200)};pvm.generateNodeCoordinates=function(e){function l(e,t,n,r,i,s,o,u){var a=(r-t)/(n-e),f=t-a*e,l=(u-s)/(o-i),c=s-l*i;if((r-t)*(o-i)===(n-e)*(u-s))return!1;var h=-(f-c)/(a-l);return Math.min(e,n)<h&&h<Math.max(e,n)&&Math.min(i,o)<h&&h<Math.max(i,o)}function c(e,t,n,r){var i=Math.pow(e-n,2),s=Math.pow(t-r,2);return Math.sqrt(i+s)}function h(e){return e.hasOwnProperty("currency")?e.currency:"XRP"}var t=pvm.force.nodes(),n,r,i,s;for(;;){n=(Math.random()*.8+.1)*pvm.WIDTH;r=(Math.random()*.8+.1)*pvm.HEIGHT;i=(Math.random()*.8+.1)*pvm.WIDTH;s=(Math.random()*.8+.1)*pvm.HEIGHT;if(t.length<2)break;var o=!1;for(var u=0,a=t.length-1;u<a;u+=2)if(l(n,r,i,s,t[u].x,t[u].y,t[u+1].x,t[u+1].y)){o=!0;break}var f=c(n,r,i,s);if(!o&&f>75)break}var p={x:n,y:r,id:pvm.tx_counter,color:pvm.HIGH_SATURATION_COLORS[h(e.Amount)],finalr:10+40*Math.random()};pvm.tx_counter++;var d={x:i,y:s,id:pvm.tx_counter,color:pvm.HIGH_SATURATION_COLORS[h(e.Amount)],finalr:10+40*Math.random()};pvm.tx_counter++;var v=p.id+"_"+d.id,m={source:p,target:d,id:v,r1:p.finalr,r2:d.finalr,amount:e.Amount};return m};pvm.addNodesToD3=function(e){var t=[e.source,e.target],n=pvm.force.nodes();n=n.concat(t);pvm.force.nodes(n);var r,i=pvm.svg.select("g#nodeGroup").selectAll("circle.node").data(n).enter().append("svg:circle").attr("class","node").style("opacity","0.2").style("stroke-width","1").style("stroke","white").attr("id",function(e){return e.id}).attr("title",function(e){return e.id}).style("fill",function(e){return e.color}).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}).style("cursor","pointer").attr("finalr",function(e){return e.finalr}).attr("r",0);i.call(pvm.force.drag);var s=pvm.svg.select("g#linkGroup").selectAll("line").data([e],function(e){return e.id}).enter().append("svg:line").style("stroke","white").style("opacity","0.2").attr("r1",function(e){return e.r1}).attr("r2",function(e){return e.r2}).attr("id",function(e){return"link"+e.id}).attr("stroke-width",1).style("stroke-dasharray","0 999999"),o=pvm.svg.select("g#labelGroup").selectAll("foreignObject").data([e],function(e){return e.id}).enter().append("svg:foreignObject").attr("width",164).attr("height",54).attr("x",function(e){return(e.source.x+e.target.x)/2-82}).attr("y",function(e){return(e.source.y+e.target.y)/2-26});o.append("xhtml:div").attr("class","transactionLabel").text(function(e){var t;e.amount.currency?t=e.amount.value:t=parseInt(e.amount)/1e6;return t.toString()+" "}).append("xhtml:span").attr("class","currencyName").text(function(e){var t;e.amount.currency?t=e.amount.currency:t="XRP";return t});pvm.force.start();$("circle.node[r=0]").each(function(e,t){pvm.animateAttr("#"+$(t).attr("id"),"r",$(t).attr("finalr"),100)});setTimeout(function(){pvm.animateAttr("#"+t[0].id,"r",0,50);pvm.animateAttr("#"+t[1].id,"r",0,100);setTimeout(function(){i.remove();s.remove();o.remove();var e=pvm.force.nodes();e=e.filter(function(e,n){var r=!1;t.forEach(function(t,n){e.id===t.id&&(r=!0)});return!r});pvm.force.nodes(e)},100)},3600)};pvm.HIGH_SATURATION_COLORS={__N:"#f00",BTC:"#fa0",JPY:"#af0",USD:"#0f0",AUD:"#0fa",XRP:"#0af",___:"#00f",CAD:"#a0f",EUR:"#f0a"};pvm.lineLength=function(e){var t=Math.pow(e.attr("x1")-e.attr("x2"),2),n=Math.pow(e.attr("y1")-e.attr("y2"),2);return Math.sqrt(t+n)};pvm.animateLine=function(e,t,n,r){var i=0,s=parseInt(e.attr("r1")),o=pvm.lineLength(e)-s,u=setInterval(function(){var a=o*i;t==1?e.css("stroke-dasharray","0 "+s+" "+a+" 999999"):e.css("stroke-dasharray","0 "+s+" 0 "+a+" 999999");i+=n;if(i>=1){t==1?e.css("stroke-dasharray","0 "+s+" 999999"):e.css("display","none");clearInterval(u);r&&r(e)}},20)};pvm.animateAttr=function(e,t,n,r){var i,s=$(e);"undefined"==typeof r&&(r=1e3);var o=$(e).attr(t),u=o,a=(n-o)/r,f=a>0;i=setInterval(function(){u=parseFloat(u)+15*a;if(f&&u>=n||!f&&u<=n){clearInterval(i);u=n}u<0&&alert(u+" TOWARDS "+n+" INCREASING?"+f);s.attr(t,u)},15)};pvm.resizeNodes=function(e){pvm.animateAttr(".node","r",e,400)};var paymentVisualizationModule=pvm;